<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Walker Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        [data-theme="dark"] {
            --bg-gradient-1: #0f0c29;
            --bg-gradient-2: #302b63;
            --bg-gradient-3: #24243e;
            --card-bg: rgba(255, 255, 255, 0.06);
            --card-border: rgba(255, 255, 255, 0.1);
            --card-shadow: rgba(0, 0, 0, 0.4);
            --text-primary: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #7c3aed;
            --accent-light: #a78bfa;
            --input-bg: rgba(255, 255, 255, 0.06);
            --input-border: rgba(255, 255, 255, 0.12);
            --table-border: rgba(255, 255, 255, 0.08);
            --toggle-bg: rgba(255, 255, 255, 0.1);
            --toggle-hover: rgba(255, 255, 255, 0.18);
        }

        [data-theme="light"] {
            --bg-gradient-1: #e8eaf6;
            --bg-gradient-2: #f5f5ff;
            --bg-gradient-3: #e0e7ff;
            --card-bg: rgba(255, 255, 255, 0.55);
            --card-border: rgba(255, 255, 255, 0.6);
            --card-shadow: rgba(0, 0, 0, 0.08);
            --text-primary: #1e293b;
            --text-muted: #64748b;
            --accent: #7c3aed;
            --accent-light: #a78bfa;
            --input-bg: rgba(255, 255, 255, 0.5);
            --input-border: rgba(0, 0, 0, 0.1);
            --table-border: rgba(0, 0, 0, 0.08);
            --toggle-bg: rgba(0, 0, 0, 0.06);
            --toggle-hover: rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-1), var(--bg-gradient-2), var(--bg-gradient-3));
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1.5rem;
            transition: background 0.3s ease;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto 1.5rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-light);
        }

        .header-title p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.15rem;
        }

        .theme-toggle {
            background: var(--toggle-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-primary);
            transition: background 0.2s ease;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .theme-toggle:hover { background: var(--toggle-hover); }

        .filters {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 1400px;
            margin: 0 auto 1.5rem;
            padding: 1rem 1.25rem;
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--card-border);
            border-radius: 14px;
            box-shadow: 0 4px 24px var(--card-shadow);
        }

        .filters label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
            font-weight: 500;
        }

        .filters input,
        .filters select {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            padding: 0.45rem 0.65rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .filters input:focus,
        .filters select:focus {
            border-color: var(--accent-light);
        }

        [data-theme="dark"] .filters select option {
            background: #1e1b4b;
            color: #e2e8f0;
        }

        [data-theme="light"] .filters select option {
            background: #ffffff;
            color: #1e293b;
        }

        .btn {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            font-size: 0.9rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .btn:hover { background: var(--accent-light); }
        .btn:active { transform: scale(0.97); }

        .grid-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--card-border);
            border-radius: 14px;
            padding: 1.25rem;
            box-shadow: 0 4px 24px var(--card-shadow);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .card.full-width { grid-column: 1 / -1; }

        .card h3 {
            margin: 0 0 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent-light);
        }

        .no-data {
            text-align: center;
            color: var(--text-muted);
            padding: 2rem 0;
            font-style: italic;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        table th,
        table td {
            text-align: left;
            padding: 0.55rem 0.75rem;
            border-bottom: 1px solid var(--table-border);
        }

        table th {
            color: var(--accent-light);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        table td { color: var(--text-primary); }

        .rank { color: var(--accent); font-weight: 700; }

        @media (max-width: 768px) {
            body { padding: 1rem; }
            .grid-dashboard { grid-template-columns: 1fr; }
            .filters { flex-direction: column; align-items: stretch; }
            .header h1 { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <h1>Dog Walker Dashboard</h1>
            <p>Walk tracking statistics and insights</p>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
            <span id="theme-icon"></span>
        </button>
    </div>

    <div class="filters">
        <div>
            <label for="start">From</label>
            <input type="date" id="start">
        </div>
        <div>
            <label for="end">To</label>
            <input type="date" id="end">
        </div>
        <div>
            <label for="user">Walker</label>
            <select id="user">
                <option value="">All walkers</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button class="btn" onclick="applyFilters()">Apply</button>
        </div>
    </div>

    <div class="grid-dashboard">
        <div class="card">
            <h3>Leaderboard</h3>
            <div id="leaderboard"></div>
        </div>
        <div class="card">
            <h3>Walks Per Day</h3>
            <div id="walks-per-day"></div>
        </div>
        <div class="card full-width">
            <h3>Weekly Trends</h3>
            <div id="weekly-trends"></div>
        </div>
        <div class="card">
            <h3>Poop Stats</h3>
            <div id="poop-stats"></div>
        </div>
        <div class="card">
            <h3>Long Walk %</h3>
            <div id="long-walk-stats"></div>
        </div>
        <div class="card full-width">
            <h3>Walk Times (Hourly Distribution)</h3>
            <div id="hourly-dist"></div>
        </div>
    </div>

<script>
// Telegram WebApp integration
const tg = window.Telegram && window.Telegram.WebApp;
if (tg) { tg.ready(); tg.expand(); }
const initData = tg ? tg.initData : '';

const chartColors = ['#7c3aed', '#f43f5e', '#06b6d4', '#f59e0b', '#a78bfa', '#fb7185', '#22d3ee', '#fbbf24'];
let charts = {};

function getTheme() {
    return document.documentElement.getAttribute('data-theme') || 'dark';
}

function getChartOpts() {
    const isDark = getTheme() === 'dark';
    return {
        foreColor: isDark ? '#e2e8f0' : '#334155',
        gridColor: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)',
        tooltipTheme: isDark ? 'dark' : 'light',
        trackBg: isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)',
        totalLabelColor: isDark ? '#e2e8f0' : '#334155',
        valueFontColor: isDark ? '#fff' : '#1e293b',
        legendColor: isDark ? '#e2e8f0' : '#334155'
    };
}

function initTheme() {
    const saved = localStorage.getItem('dashboard-theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    updateThemeIcon();
}

function toggleTheme() {
    const next = getTheme() === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('dashboard-theme', next);
    updateThemeIcon();
    applyFilters();
}

function updateThemeIcon() {
    document.getElementById('theme-icon').textContent = getTheme() === 'dark' ? '\u2600\uFE0F' : '\uD83C\uDF19';
}

function destroyCharts() {
    Object.values(charts).forEach(c => { try { c.destroy(); } catch(e) {} });
    charts = {};
}

function noData(el) {
    document.getElementById(el).innerHTML = '<div class="no-data">No data for selected period</div>';
}

function setDefaults() {
    const today = new Date();
    const start = new Date(today);
    start.setDate(start.getDate() - 13);
    document.getElementById('start').value = start.toISOString().split('T')[0];
    document.getElementById('end').value = today.toISOString().split('T')[0];
}

async function fetchData() {
    const start = document.getElementById('start').value;
    const end = document.getElementById('end').value;
    const userId = document.getElementById('user').value;
    const params = new URLSearchParams();
    if (start) params.set('start', start);
    if (end) params.set('end', end);
    if (userId) params.set('user_id', userId);
    const headers = {};
    if (initData) headers['X-Telegram-Init-Data'] = initData;
    const resp = await fetch('/api/dashboard?' + params.toString(), { headers });
    return await resp.json();
}

function renderLeaderboard(data) {
    const el = document.getElementById('leaderboard');
    if (!data.length) { noData('leaderboard'); return; }
    let html = '<table><thead><tr><th>#</th><th>Walker</th><th>Walks</th></tr></thead><tbody>';
    data.forEach((r, i) => {
        html += `<tr><td class="rank">${i + 1}</td><td>${r.name}</td><td>${r.walk_count}</td></tr>`;
    });
    html += '</tbody></table>';
    el.innerHTML = html;
}

function renderWalksPerDay(data) {
    if (!data.length) { noData('walks-per-day'); return; }
    const opts = getChartOpts();
    charts.walksPerDay = new ApexCharts(document.getElementById('walks-per-day'), {
        chart: { type: 'bar', height: 300, background: 'transparent', foreColor: opts.foreColor },
        series: [{ name: 'Walks', data: data.map(d => d.count) }],
        xaxis: { categories: data.map(d => d.day), labels: { rotate: -45, style: { fontSize: '10px' } } },
        colors: [chartColors[0]],
        plotOptions: { bar: { borderRadius: 4, columnWidth: '60%' } },
        dataLabels: { enabled: false },
        grid: { borderColor: opts.gridColor },
        tooltip: { theme: opts.tooltipTheme }
    });
    charts.walksPerDay.render();
}

function renderWeeklyTrends(data) {
    if (!data.length) { noData('weekly-trends'); return; }
    const opts = getChartOpts();
    charts.weeklyTrends = new ApexCharts(document.getElementById('weekly-trends'), {
        chart: { type: 'area', height: 280, background: 'transparent', foreColor: opts.foreColor },
        series: [{ name: 'Walks', data: data.map(d => d.count) }],
        xaxis: { categories: data.map(d => d.week_start) },
        colors: [chartColors[2]],
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1 } },
        stroke: { curve: 'smooth', width: 3 },
        dataLabels: { enabled: false },
        grid: { borderColor: opts.gridColor },
        tooltip: { theme: opts.tooltipTheme }
    });
    charts.weeklyTrends.render();
}

function renderPoopStats(data) {
    if (!data.length) { noData('poop-stats'); return; }
    const opts = getChartOpts();
    const totalWalks = data.reduce((s, d) => s + d.total, 0);
    const totalDidntPoop = data.reduce((s, d) => s + d.didnt_poop_count, 0);
    const pooped = totalWalks - totalDidntPoop;
    charts.poopStats = new ApexCharts(document.getElementById('poop-stats'), {
        chart: { type: 'donut', height: 300, background: 'transparent', foreColor: opts.foreColor },
        series: [pooped, totalDidntPoop],
        labels: ['Pooped', "Didn't poop"],
        colors: [chartColors[2], chartColors[1]],
        legend: { position: 'bottom', labels: { colors: opts.legendColor } },
        plotOptions: { pie: { donut: { labels: { show: true, total: { show: true, label: 'Total', color: opts.totalLabelColor } } } } },
        dataLabels: { style: { fontSize: '14px' } },
        tooltip: { theme: opts.tooltipTheme }
    });
    charts.poopStats.render();
}

function renderLongWalkStats(data) {
    if (!data.length) { noData('long-walk-stats'); return; }
    const opts = getChartOpts();
    const names = data.map(d => d.name);
    const pcts = data.map(d => d.total > 0 ? Math.round((d.long_walk_count / d.total) * 100) : 0);
    charts.longWalks = new ApexCharts(document.getElementById('long-walk-stats'), {
        chart: { type: 'radialBar', height: 300, background: 'transparent', foreColor: opts.foreColor },
        series: pcts,
        labels: names,
        colors: chartColors.slice(0, names.length),
        plotOptions: {
            radialBar: {
                hollow: { size: '35%' },
                dataLabels: {
                    name: { fontSize: '14px', color: opts.foreColor },
                    value: { fontSize: '18px', color: opts.valueFontColor, formatter: v => v + '%' }
                },
                track: { background: opts.trackBg }
            }
        },
        legend: { show: true, position: 'bottom', labels: { colors: opts.legendColor } }
    });
    charts.longWalks.render();
}

function renderHourlyDist(data) {
    if (!data.length) { noData('hourly-dist'); return; }
    const opts = getChartOpts();
    const hours = Array.from({ length: 24 }, (_, i) => i);
    const counts = hours.map(h => {
        const found = data.find(d => d.hour === h);
        return found ? found.count : 0;
    });
    const labels = hours.map(h => h.toString().padStart(2, '0') + ':00');
    charts.hourly = new ApexCharts(document.getElementById('hourly-dist'), {
        chart: { type: 'bar', height: 280, background: 'transparent', foreColor: opts.foreColor },
        series: [{ name: 'Walks', data: counts }],
        xaxis: { categories: labels, labels: { rotate: -45, style: { fontSize: '10px' } } },
        colors: [chartColors[3]],
        plotOptions: { bar: { borderRadius: 3, columnWidth: '55%' } },
        dataLabels: { enabled: false },
        grid: { borderColor: opts.gridColor },
        tooltip: { theme: opts.tooltipTheme }
    });
    charts.hourly.render();
}

async function applyFilters() {
    destroyCharts();
    document.querySelectorAll('.card div[id]').forEach(el => { el.innerHTML = ''; });
    const data = await fetchData();
    renderLeaderboard(data.leaderboard);
    renderWalksPerDay(data.walks_per_day);
    renderWeeklyTrends(data.weekly_trends);
    renderPoopStats(data.poop_stats);
    renderLongWalkStats(data.long_walk_stats);
    renderHourlyDist(data.hourly_distribution);
}

initTheme();
setDefaults();
applyFilters();
</script>
</body>
</html>
